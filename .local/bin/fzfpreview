#!/bin/sh

tmp_img=$(mktemp /tmp/fzf-preview.XXXXXXXXXX)
tmp_ueberzug_file=""

# Choose image previewer
if command -v ueberzug > /dev/null; then
    image_preview="ueberzug_preview"
    # Initialize ueberzug (listen to /tmp/fzf-ueberzug.XXXXXXXXXX)
    tmp_ueberzug_file=$(mktemp /tmp/fzf-ueberzug.XXXXXXXXXX)
    if command -v ueberzugpp > /dev/null; then
        tail -f --pid=$$ $tmp_ueberzug_file 2> /dev/null | ueberzugpp layer --silent &
    else
        tail -f --pid=$$ $tmp_ueberzug_file 2> /dev/null | ueberzug layer --silent &
    fi
elif [[ $KITTY_WINDOW_ID ]]; then
    image_preview="kitty_preview"
elif command -v chafa > /dev/null; then
    image_preview="chafa_preview"
elif command -v catimg > /dev/null; then
    image_preview="catimg_preview"
else
    image_preview="no_image_preview"
fi

cleanup () {
    # Clear last image and remove temporary files
    if command -v ueberzug > /dev/null; then
        echo '{"action": "remove", "identifier": "fzf"}' >> $tmp_ueberzug_file
    fi
    rm -f $tmp_img $tmp_ueberzug_file
}
trap cleanup HUP

# Set fzf command
if command -v fd > /dev/null; then
    export FZF_DEFAULT_COMMAND='fd -H --type file'
fi

# Set fzf default options (preview command, refresh on terminal resize, show header)
export FZF_DEFAULT_OPTS="\
--preview 'fzf-file2preview {} $image_preview $tmp_img $tmp_ueberzug_file'
--bind 'resize:refresh-preview' --bind 'focus:transform-header:file --brief {}'
--layout=reverse
"

fzf --multi \
  	--bind "ctrl-d:execute(rm -v \$(readlink -f {+}))+reload(find . -type f)" \
	--bind "ctrl-o:execute(
	 	for f in {+}; do
	   	setsid -f xdg-open \"$(readlink -f \"\$f\")\" >/dev/null 2>&1
	 	done
	)+abort" \
  	--bind "ctrl-b:execute(blobdrop \$(readlink -f {+}))+abort" \
	--bind "ctrl-c,ctrl-y,enter:execute(
		notify-send \"Copied $(readlink -f {..}) to Clipboard\" &&
		printf %s $(readlink -f {..}) | xsel -b 2>/dev/null || printf %s $(readlink -f {..}) | xclip -selection clipboard -r 2>/dev/null
		)+abort"\
	--bind "ctrl-alt-o:execute(
	 	for f in {+}; do
	   	setsid -f xdg-open \"$(readlink -f \"\$f\")\" >/dev/null 2>&1
	 	done
	)" \
	--bind "ctrl-alt-b:execute(blobdrop $(readlink -f {+}))" \
	--bind "ctrl-alt-c,ctrl-alt-y:execute(printf %s $(readlink -f {..}) | xsel -b 2>/dev/null || printf %s $(readlink -f {..}) | xclip -selection clipboard -r 2>/dev/null)"
# maybe mimeopen?
# 	--bind "ctrl-o:execute(setsid -f mimeopen -n \$(readlink -f {+}) 2>/dev/null)+abort" \

cleanup &
