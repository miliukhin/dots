#!/bin/sh

# Ð¯ÐºÑ‰Ð¾ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½ÑŒ Ð±Ð°Ð³Ð°Ñ‚Ð¾ Ñ‚Ð¾ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ðµ Ð¼Ð¾Ð¶Ðµ Ð½Ðµ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ñ‚Ð¸ÑÑŒ. Ð Ñ–Ð´ÐºÐ¾, Ð°Ð»Ðµ ÑÑ‚Ð°Ñ”Ñ‚ÑŒÑÑ.
# Ð¢Ð°ÐºÐ¾Ð¶ Ð±ÑƒÐ»Ð¾ Ð± Ð´Ð¾Ð±Ñ€Ðµ Ð¿Ð¾Ð·Ð±ÑƒÑ‚Ð¸ÑÑ Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚Ñ– Ð²Ñ–Ð´ Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼Ñƒ (Ñ‡ÐµÑ€ÐµÐ· Ð½ÑŒÐ¾Ð³Ð¾, Ð´Ð¾ Ñ€ÐµÑ‡Ñ–, Ð¹ Ñ‚Ð°ÐºÐ° Ð½ÐµÑÑ‚Ð°Ð±Ñ–Ð»ÑŒÐ½Ñ–ÑÑ‚ÑŒ)
# https://telegram.me/s/air_alert_ua

region="${XDG_CACHE_HOME:-$HOME/.cache}/region"

pickregion() { chosen="$(echo "ÐÐ²Ñ‚Ð¾Ð½Ð¾Ð¼Ð½Ð° Ð ÐµÑÐ¿ÑƒÐ±Ð»Ñ–ÐºÐ° ÐšÑ€Ð¸Ð¼
Ð’Ñ–Ð½Ð½Ð¸Ñ†ÑŒÐºÐ°
Ð’Ð¾Ð»Ð¸Ð½ÑÑŒÐºÐ°
Ð”Ð½Ñ–Ð¿Ñ€Ð¾Ð¿ÐµÑ‚Ñ€Ð¾Ð²ÑÑŒÐºÐ°
Ð”Ð¾Ð½ÐµÑ†ÑŒÐºÐ°
Ð–Ð¸Ñ‚Ð¾Ð¼Ð¸Ñ€ÑÑŒÐºÐ°
Ð—Ð°ÐºÐ°Ñ€Ð¿Ð°Ñ‚ÑÑŒÐºÐ°
Ð—Ð°Ð¿Ð¾Ñ€Ñ–Ð·ÑŒÐºÐ°
Ð†Ð²Ð°Ð½Ð¾-Ð¤Ñ€Ð°Ð½ÐºÑ–Ð²ÑÑŒÐºÐ°
ÐšÐ¸Ñ—Ð²ÑÑŒÐºÐ°
ÐšÑ–Ñ€Ð¾Ð²Ð¾Ð³Ñ€Ð°Ð´ÑÑŒÐºÐ°
Ð›ÑƒÐ³Ð°Ð½ÑÑŒÐºÐ°
Ð›ÑŒÐ²Ñ–Ð²ÑÑŒÐºÐ°
ÐœÐ¸ÐºÐ¾Ð»Ð°Ñ—Ð²ÑÑŒÐºÐ°
ÐžÐ´ÐµÑÑŒÐºÐ°
ÐŸÐ¾Ð»Ñ‚Ð°Ð²ÑÑŒÐºÐ°
Ð Ñ–Ð²Ð½ÐµÐ½ÑÑŒÐºÐ°
Ð¡ÑƒÐ¼ÑÑŒÐºÐ°
Ð¢ÐµÑ€Ð½Ð¾Ð¿Ñ–Ð»ÑŒÑÑŒÐºÐ°
Ð¥Ð°Ñ€ÐºÑ–Ð²ÑÑŒÐºÐ°
Ð¥ÐµÑ€ÑÐ¾Ð½ÑÑŒÐºÐ°
Ð¥Ð¼ÐµÐ»ÑŒÐ½Ð¸Ñ†ÑŒÐºÐ°
Ð§ÐµÑ€ÐºÐ°ÑÑŒÐºÐ°
Ð§ÐµÑ€Ð½Ñ–Ð²ÐµÑ†ÑŒÐºÐ°
Ð§ÐµÑ€Ð½Ñ–Ð³Ñ–Ð²ÑÑŒÐºÐ°" | dmenu -r -i -l 50 -p "ÐžÐ±ÐµÑ€Ñ–Ñ‚ÑŒ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ:")"
echo "$chosen" > "$region"
}

oblast="$(cat $region)"
map="${XDG_CACHE_HOME:-$HOME/.cache}/alertmap.png"
hist="${XDG_CACHE_HOME:-$HOME/.cache}/alert"

getalerts() {
	now=$(curl -sL https://telegram.me/s/air_alert_ua | grep "$oblast Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ" | tail -1)
	[ "$(tail -1 "$hist")" = "$now" ] || (echo "$now" >> "$hist" && notify-send -u critical "$(echo "$now" | sed -e 's/<[^>]*>//g; s/\..*//g' | head -n 1)")
	tail -1 "$hist" | grep "Ñ‚Ñ€Ð¸Ð²Ð¾Ð³Ð°" >> /dev/null && echo ðŸ“¢ || echo ðŸ”±
}

showalert() {
	tail -1 "$hist" | grep "Ñ‚Ñ€Ð¸Ð²Ð¾Ð³Ð°" >> /dev/null && notify-send "ðŸ“¢ Ð£ Ð²Ð°ÑˆÑ–Ð¹ Ð¾Ð±Ð»Ð°ÑÑ‚Ñ– Ð¿Ð¾Ð²Ñ–Ñ‚Ñ€ÑÐ½Ð° Ñ‚Ñ€Ð¸Ð²Ð¾Ð³Ð°!" || notify-send "ðŸ”± Ð£ Ð²Ð°ÑˆÑ–Ð¹ Ð¾Ð±Ð»Ð°ÑÑ‚Ñ– Ð½ÐµÐ±Ð¾ Ñ‡Ð¸ÑÑ‚Ðµ"
}

case $BLOCK_BUTTON in
	1) [ ! -f "$region" ] && pickregion
		notify-send "ðŸ”± ÐžÐ½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–ÑŽ Ð¿Ñ€Ð¾ Ñ‚Ñ€Ð¸Ð²Ð¾Ð³Ð¸..." && getalerts && showalert  ;;
	2) notify-send "" ;;
	3) notify-send "ÐœÐ¾Ð´ÑƒÐ»ÑŒ Ð¿Ð¾Ð²Ñ–Ñ‚Ñ€ÑÐ½Ð¾Ñ— Ñ‚Ñ€Ð¸Ð²Ð¾Ð³Ð¸" "Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ Ð¼Ð°Ð¿Ð¸..." & \
		curl -sL "https://alerts.com.ua/map.png" > "$map" && setsid nsxiv "$map" ;;
	6) "$TERMINAL" -e "$EDITOR" "$0" ;;
esac;

getalerts
